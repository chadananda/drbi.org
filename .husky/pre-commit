echo "ðŸ”¨ Running pre-commit checks..."

# Run Vercel build to catch production compatibility issues (ESM, serverless, etc.)
# Falls back to npm build if vercel CLI has configuration issues
echo "ðŸ“¦ Running Vercel build (production simulation)..."

VERCEL_OUTPUT=$(vercel build 2>&1)
VERCEL_EXIT=$?

if [ $VERCEL_EXIT -ne 0 ]; then
  # Check if it's a configuration error vs actual build error
  if echo "$VERCEL_OUTPUT" | grep -q "Project Settings\|must be upgraded\|WARN.*not running on Vercel"; then
    echo "âš ï¸  Vercel CLI config issue detected. Falling back to npm build..."
    echo "   (Update Node.js version in Vercel dashboard to fix)"
    npm run build
    if [ $? -ne 0 ]; then
      echo "âŒ Build failed! Please fix the errors before committing."
      exit 1
    fi
  else
    echo "$VERCEL_OUTPUT" | tail -30
    echo "âŒ Vercel build failed! Please fix the errors before committing."
    exit 1
  fi
else
  echo "$VERCEL_OUTPUT" | tail -10
fi

echo "âœ… Build passed!"

# Run E2E tests (start dev server, run tests, stop server)
echo "ðŸ§ª Running E2E tests..."

# Start dev server in background
npm run dev > /tmp/astro-test-server.log 2>&1 &
DEV_PID=$!

# Wait for server to be ready (max 30 seconds)
echo "â³ Waiting for dev server..."
for i in {1..30}; do
  if curl -s -o /dev/null -w "" http://localhost:4321/ 2>/dev/null; then
    break
  fi
  if curl -s -o /dev/null -w "" http://localhost:4322/ 2>/dev/null; then
    export BASE_URL=http://localhost:4322
    break
  fi
  sleep 1
done

# Set BASE_URL if not already set
if [ -z "$BASE_URL" ]; then
  export BASE_URL=http://localhost:4321
fi

# Run critical tests only (faster subset)
npx playwright test tests/homepage.spec.js tests/build-integrity.spec.js --reporter=line

TEST_EXIT_CODE=$?

# Kill dev server
kill $DEV_PID 2>/dev/null || true

# Check if tests succeeded
if [ $TEST_EXIT_CODE -ne 0 ]; then
  echo "âŒ E2E tests failed! Please fix the issues before committing."
  exit 1
fi

echo "âœ… E2E tests passed!"

# Add any modified analytics files to the commit
if [ -f "src/data/analytics-summary.json" ]; then
  git add src/data/analytics-summary.json 2>/dev/null || true
fi

echo "âœ… All checks passed! Proceeding with commit..."
